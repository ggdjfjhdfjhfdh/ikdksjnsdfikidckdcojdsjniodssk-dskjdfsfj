function e(){const e=document.getElementById("ticket-form"),t=document.querySelector(".emergency-options");e&&(e.style.display="block"),t&&(t.style.display="none"),function(){try{const e=localStorage.getItem("emergency_ticket_draft");if(e){const t=JSON.parse(e);if(t.incidentType&&(document.getElementById("incident-type").value=t.incidentType),t.description&&(document.getElementById("incident-description").value=t.description),t.urgency){const e=document.querySelector('input[name="urgency"]');e&&(e.value=t.urgency)}n("incident-type"),n("incident-description")}}catch(e){console.error("Error al restaurar datos:",e)}}(),setTimeout(()=>{document.getElementById("incident-type")?.focus()},100)}function t(){document.getElementById("incident-description").value="",localStorage.removeItem("emergency_ticket_draft")}function n(e){const t=document.getElementById(e),n=document.getElementById(`${e}-error`);if(!t)return!0;const i=t.value.trim();let o=!0,c="";switch(e){case"incident-type":i||(o=!1,c="Por favor, selecciona el tipo de incidente");break;case"incident-description":i?i.length<10&&(o=!1,c="La descripción debe tener al menos 10 caracteres"):(o=!1,c="Por favor, describe el incidente");break;case"contact-name":i?i.length<2&&(o=!1,c="El nombre debe tener al menos 2 caracteres"):(o=!1,c="Por favor, ingresa tu nombre");break;case"contact-email":i?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i)||(o=!1,c="Por favor, ingresa un email válido"):(o=!1,c="Por favor, ingresa tu email")}return n&&(o?(n.style.display="none",t.classList.remove("error")):(n.textContent=c,n.style.display="block",t.classList.add("error"))),o}function i(){const e=document.getElementById("submit-ticket-btn");if(!e)return;const t=["incident-type","incident-description","contact-name","contact-email"].every(e=>{const t=document.getElementById(e);if(!t||!t.value.trim())return!1;const n=t.value.trim();switch(e){case"incident-type":return""!==n;case"incident-description":return n.length>=10;case"contact-name":return n.length>=2;case"contact-email":return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n);default:return!0}});e.disabled=!t}function o(e,t="info",n=3e3){const i=document.createElement("div");i.className=`notification ${t}`,i.style.cssText=`\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: ${"success"===t?"#10b981":"error"===t?"#ef4444":"#3b82f6"};\n      color: white;\n      padding: 1rem 1.5rem;\n      border-radius: 0.5rem;\n      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);\n      z-index: 1000;\n      font-weight: 600;\n      max-width: 300px;\n      word-wrap: break-word;\n    `,i.textContent=e,document.body.appendChild(i),setTimeout(()=>{i.parentNode&&i.parentNode.removeChild(i)},n)}async function c(){try{const e=await fetch("https://api.ipify.org?format=json");return(await e.json()).ip||"unknown"}catch(e){return console.warn("No se pudo obtener la IP:",e),"unknown"}}async function r(){const e=document.getElementById("submit-ticket-btn"),n=e?.querySelector(".btn-text"),i=e?.querySelector(".btn-loading");if(!e||e.disabled)return;n&&(n.style.display="none"),i&&(i.style.display="inline"),e&&(e.disabled=!0);const r=document.getElementById("incident-type").value,a={type:"security_incident",incident_type:r,description:document.getElementById("incident-description").value.trim(),priority:"critical",response_time:"inmediata",timestamp:(new Date).toISOString(),userAgent:navigator.userAgent.substring(0,100),location:window.location.hostname,ip:await c(),additional_data:JSON.stringify({})},d=new FormData;Object.entries(a).forEach(([e,t])=>d.append(e,t)),console.log("📤 Datos del ticket:",a);for(let[t,o]of d.entries())console.log(`   ${t}:`,o);const s=document.getElementById("attachments").files,l=s&&s.length>0;let m;l&&Array.from(s).slice(0,5).forEach(e=>d.append("attachments",e));const u={"X-Emergency-Token":"89ae197c406d9683548b2a55a8bc6260f2733dfc4941acfcbe39efdf0d56df25"};l?m=d:(m=new URLSearchParams(a).toString(),u["Content-Type"]="application/x-www-form-urlencoded");try{const e="https://sesec-backend.fly.dev",n=await fetch(`${e}/api/tickets/security-incidents`,{method:"POST",headers:u,body:m,signal:AbortSignal.timeout(7e3)});if(!n.ok)throw new Error(`Error del servidor: ${n.status}`);{const e=await n.json();o(`🚨 Ticket creado exitosamente (ID: ${e.ticket?.id||"N/A"})`,"success",3e3),e.ticket?.id&&(window.location.href=`/incidente/${e.ticket.id}?type=${encodeURIComponent(r)}`),t(),function(){const e=document.getElementById("ticket-form"),n=document.querySelector(".emergency-options");e&&(e.style.display="none"),n&&(n.style.display="flex"),t()}(),console.log("✅ Ticket creado exitosamente:",e)}}catch(y){console.error("❌ Error al enviar ticket:",y),o("❌ Error al enviar el ticket. Por favor, inténtalo de nuevo o contacta por WhatsApp.","error",5e3),n&&(n.style.display="inline"),i&&(i.style.display="none"),e&&(e.disabled=!1)}}document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("show-ticket-form-btn");t&&t.addEventListener("click",e);const o=document.getElementById("submit-ticket-btn");o&&o.addEventListener("click",r);const c=document.getElementById("incident-type"),a=document.getElementById("incident-description"),d=document.getElementById("contact-name"),s=document.getElementById("contact-email");c&&(c.addEventListener("input",()=>{n("incident-type"),i()}),c.addEventListener("blur",()=>{n("incident-type"),i()})),a&&(a.addEventListener("input",()=>{n("incident-description"),i()}),a.addEventListener("blur",()=>{n("incident-description"),i()})),d&&(d.addEventListener("input",()=>{n("contact-name"),i()}),d.addEventListener("blur",()=>{n("contact-name"),i()})),s&&(s.addEventListener("input",()=>{n("contact-email"),i()}),s.addEventListener("blur",()=>{n("contact-email"),i()})),i()});
