class t{constructor(){this.apiEndpoint="https://sesec-backend.fly.dev/api/threat/data",this.refreshInterval=9e5,this.retryAttempts=3,this.retryDelay=5e3}animateCounter(t,e,a=2e3){const r=parseInt(t.textContent.replace(/[^0-9]/g,""))||0,o=performance.now();requestAnimationFrame(function s(n){const i=n-o,c=Math.min(i/a,1),d=(l=c,1-Math.pow(1-l,4));var l;const u=Math.floor(r+(e-r)*d);t.textContent=u.toLocaleString(),c<1&&requestAnimationFrame(s)})}drawSparkline(t,e){const a=t.getContext("2d"),r=t.width,o=t.height;if(a.clearRect(0,0,r,o),!e||0===e.length)return;const s=Math.max(...e),n=Math.min(...e),i=s-n||1,c=a.createLinearGradient(0,0,0,o);c.addColorStop(0,"rgba(59, 130, 246, 0.8)"),c.addColorStop(1,"rgba(59, 130, 246, 0.2)"),a.beginPath(),a.moveTo(2,o-2),e.forEach((t,s)=>{const c=2+s/(e.length-1)*(r-4),d=o-2-(t-n)/i*(o-4);a.lineTo(c,d)}),a.lineTo(r-2,o-2),a.closePath(),a.fillStyle=c,a.fill(),a.beginPath(),e.forEach((t,s)=>{const c=2+s/(e.length-1)*(r-4),d=o-2-(t-n)/i*(o-4);0===s?a.moveTo(c,d):a.lineTo(c,d)}),a.strokeStyle="rgba(59, 130, 246, 1)",a.lineWidth=1.5,a.stroke()}updateAPIStatus(t,e,a="free"){const r=document.querySelector(`[data-api="${t}"]`);if(!r)return;const o=r.querySelector(".status-indicator"),s=r.querySelector(".api-status");if(o&&o.setAttribute("data-status",e),s){s.setAttribute("data-status",e);let t="";switch(e){case"ok":t="ðŸŸ¢ En lÃ­nea";break;case"fallback":t="ðŸŸ¡ Datos simulados";break;case"requires_token":t="ðŸ”‘ Requiere token";break;case"error":t="ðŸ”´ Error";break;default:t="ðŸŸ¡ Cargando..."}s.textContent=t}}hideLoadingStates(t){t.querySelectorAll(".loading-skeleton, .sparkline-loading, .port-loading").forEach(t=>{t.style.opacity="0",setTimeout(()=>t.style.display="none",300)})}updateCardData(t,e){const a=document.querySelector(`[data-api="${t}"]`);if(a){if(this.hideLoadingStates(a),e.error){this.updateAPIStatus(t,"error");const r=a.querySelector(".card-subtitle");return void(r&&(r.textContent=`Error: ${e.error}`))}switch(this.updateAPIStatus(t,"ok"),t){case"urlhaus":this.updateURLhausCard(a,e);break;case"cloudflare":this.updateCloudflareCard(a,e);break;case"sansISC":this.updateSANSISCCard(a,e);break;case"ransomwatch":this.updateRansomwatchCard(a,e)}}}updateURLhausCard(t,e){const a=t.querySelector(".counter"),r=t.querySelector(".card-subtitle"),o=t.querySelector(".sparkline");a&&void 0!==e.count&&this.animateCounter(a,e.count),r&&(r.textContent="Detectadas Ãºltimas 24h"),o&&e.trend&&this.drawSparkline(o,e.trend)}updateCloudflareCard(t,e){const a=t.querySelector(".counter"),r=t.querySelector(".card-subtitle-modern"),o=t.querySelector(".sparkline"),s=t.querySelector(".trend-text"),n=e.topAttackPairs?e.topAttackPairs.reduce((t,e)=>t+(e.attacks||0),0):0;if(console.log("Cloudflare Data:",e),console.log("Total Attack Pairs (index.astro):",n),console.log("Top Attack Pairs (index.astro):",e.topAttackPairs),a&&(this.animateCounter(a,n),t.querySelector(".unit").textContent=""),r){const t=e.topAttackPairs?e.topAttackPairs.length:0;r.textContent=`${t} Ataques en 24h`}s&&(s.textContent=`${n} ataques entre paÃ­ses`),o&&e.trend&&this.drawSparkline(o,e.trend)}updateSANSISCCard(t,e){const a=t.querySelectorAll(".port-item"),r=t.querySelector(".sparkline");e.ports&&a.length>=3&&e.ports.slice(0,3).forEach((t,e)=>{if(a[e]){const r=a[e].querySelector(".port-number"),o=a[e].querySelector(".port-count");r&&(r.textContent=t.port),o&&(o.textContent=`(${this.formatNumber(t.count)})`)}}),r&&e.trend&&this.drawSparkline(r,e.trend)}updateRansomwatchCard(t,e){const a=t.querySelector(".counter"),r=t.querySelector(".card-subtitle"),o=t.querySelector(".sparkline");a&&void 0!==e.count&&this.animateCounter(a,e.count),r&&(r.textContent="Publicadas Ãºltimas 24h"),o&&e.trend&&this.drawSparkline(o,e.trend)}formatNumber(t){return t>=1e6?(t/1e6).toFixed(1)+"M":t>=1e3?(t/1e3).toFixed(1)+"K":t.toString()}async fetchData(t=1){try{const t=await fetch(this.apiEndpoint,{method:"GET",headers:{Accept:"application/json","Cache-Control":"no-cache"}});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const e=await t.json();if(!e.success||!e.data)throw new Error(e.error||"Invalid API response");e.apis&&Object.entries(e.apis).forEach(([t,e])=>{this.updateAPIStatus(t,e.status,e.type)}),console.log("Datos recibidos del backend para dashboard:",e.data),this.updateDashboard(e.data)}catch(e){console.error(`API fetch attempt ${t} failed:`,e),t<this.retryAttempts?setTimeout(()=>{this.fetchData(t+1)},this.retryDelay*t):this.handleAPIError(e)}}updateDashboard(t){Object.keys(t).forEach(e=>{t[e]&&this.updateCardData(e,t[e])})}handleAPIError(t){console.error("Dashboard API Error:",t);document.querySelectorAll("[data-api]").forEach(t=>{const e=t.getAttribute("data-api");this.updateAPIStatus(e,"error"),this.hideLoadingStates(t);const a=t.querySelector(".card-subtitle");a&&(a.textContent="Error de conexiÃ³n - Reintentando...")})}updateDashboardWithStatus(t){t.apis&&Object.entries(t.apis).forEach(([t,e])=>{this.updateAPIStatus(t,e.status,e.type)}),t.data&&this.updateDashboard(t.data)}animateCards(){document.querySelectorAll(".cyber-card").forEach((t,e)=>{t.style.opacity="0",t.style.transform="translateY(20px)",setTimeout(()=>{t.style.transition="all 0.6s cubic-bezier(0.4, 0, 0.2, 1)",t.style.opacity="1",t.style.transform="translateY(0)"},150*e)})}init(){this.animateCards(),setTimeout(()=>{this.fetchData()},1e3),setInterval(()=>{this.fetchData()},this.refreshInterval)}}document.addEventListener("DOMContentLoaded",function(){(new t).init()});
