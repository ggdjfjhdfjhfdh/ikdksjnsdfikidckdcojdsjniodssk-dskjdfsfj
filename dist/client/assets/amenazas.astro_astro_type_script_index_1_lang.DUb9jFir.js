document.addEventListener("DOMContentLoaded",function(){async function e(){try{console.log("Cargando datos reales del timeline...");const e=(window.threatMapProps||{}).threatData;if(e){console.log("Usando datos de threatMapProps:",e);const t=[];let i=0,o=0;const r=new Set,s={US:"🇺🇸",CN:"🇨🇳",RU:"🇷🇺",DE:"🇩🇪",GB:"🇬🇧",FR:"🇫🇷",JP:"🇯🇵",BR:"🇧🇷",IN:"🇮🇳",KR:"🇰🇷",CA:"🇨🇦",AU:"🇦🇺",IT:"🇮🇹",ES:"🇪🇸",NL:"🇳🇱"};e.cloudflare?.topAttackPairs&&e.cloudflare.topAttackPairs.slice(0,8).forEach((e,n)=>{const a=e.value>50?"crítica":e.value>20?"alta":"media",c=new Date(Date.now()-15*n*60*1e3).toLocaleString("es-ES",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});t.push({id:`cf-${n}`,time:c,severity:a,title:`Ataque Web desde ${e.origin_country}`,description:`Detectado tráfico malicioso desde ${e.origin_country} hacia ${e.target_country} con ${(e.value||0).toFixed(1)}% del total de ataques.`,country:e.target_country,flag:s[e.target_country]||"🌍",threatType:"Web Attack",affectedSystems:Math.floor(100*(e.value||0)),source:"Cloudflare Radar",tags:["web-attack","tráfico-malicioso",e.origin_country.toLowerCase()]}),i++,"crítica"===a&&o++,r.add(e.origin_country),r.add(e.target_country)}),e.ransomwatch?.recentPosts&&e.ransomwatch.recentPosts.slice(0,6).forEach((e,n)=>{const a=new Date(e.discovered||Date.now()-30*n*60*1e3).toLocaleString("es-ES",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});t.push({id:`rw-${n}`,time:a,severity:"crítica",title:"Ataque de Ransomware Reportado",description:`Grupo ${e.group_name||"desconocido"} ha publicado: ${e.post_title}`,country:"Global",flag:"🌍",threatType:"Ransomware",affectedSystems:2500,source:"RansomWatch",tags:["ransomware",e.group_name?.toLowerCase()||"unknown","global"]}),i++,o++,r.add("Global")}),e.sansISC?.topPorts&&e.sansISC.topPorts.slice(0,4).forEach((e,n)=>{const a=new Date(Date.now()-45*n*60*1e3).toLocaleString("es-ES",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}),r=e.records>1e3?"alta":"media";t.push({id:`sans-${n}`,time:a,severity:r,title:`Escaneo Masivo en Puerto ${e.port}`,description:`Detectados ${e.records.toLocaleString()} intentos de conexión en puerto ${e.port}. Posible campaña de reconocimiento.`,country:"Global",flag:"🌐",threatType:"Port Scan",affectedSystems:e.records,source:"SANS ISC",tags:["port-scan",`puerto-${e.port}`,"reconocimiento"]}),i++,"alta"===r&&o++}),e.threatfox?.recentThreats&&e.threatfox.recentThreats.slice(0,5).forEach((e,n)=>{const a=new Date(e.first_seen||Date.now()-20*n*60*1e3).toLocaleString("es-ES",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}),r=e.confidence_level>75?"crítica":e.confidence_level>50?"alta":"media";t.push({id:`tf-${n}`,time:a,severity:r,title:"IOC de Malware Detectado",description:`Nuevo indicador de compromiso para ${e.malware||"malware desconocido"} con confianza del ${e.confidence_level||0}%.`,country:"Global",flag:"🦠",threatType:"Malware IOC",affectedSystems:1200,source:"ThreatFox",tags:["ioc","malware",e.malware?.toLowerCase()||"unknown"]}),i++,"crítica"===r&&o++}),e.feodotracker?.recentBotnets&&e.feodotracker.recentBotnets.slice(0,4).forEach((e,n)=>{const a=new Date(e.first_seen||Date.now()-35*n*60*1e3).toLocaleString("es-ES",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});t.push({id:`fd-${n}`,time:a,severity:"crítica",title:"Botnet Activa Detectada",description:`Servidor C&C de ${e.malware||"botnet desconocida"} identificado como ${e.status||"activo"}.`,country:"Global",flag:"🤖",threatType:"Botnet C2",affectedSystems:5500,source:"FeodoTracker",tags:["botnet","c2",e.malware?.toLowerCase()||"unknown"]}),i++,o++}),t.sort((e,t)=>new Date(t.time.replace(/\//g,"-")).getTime()-new Date(e.time.replace(/\//g,"-")).getTime()),window.timelineData={stats:{totalIncidents:i,criticalIncidents:o,affectedCountries:r.size},events:t.slice(0,15)},console.log("Timeline actualizado con datos reales:",window.timelineData.stats),n(),a()}else console.warn("No hay datos de threatMapProps disponibles"),window.timelineData={stats:{totalIncidents:0,criticalIncidents:0,affectedCountries:0},events:[]}}catch(e){console.error("Error cargando datos del timeline:",e),window.timelineData={stats:{totalIncidents:0,criticalIncidents:0,affectedCountries:0},events:[]}}}function t(e,t="info"){const n=document.createElement("div");n.className=`timeline-notification ${t}`,n.style.cssText=`\n             position: fixed;\n             top: 20px;\n             right: 20px;\n             background: ${"success"===t?"#10b981":"error"===t?"#ef4444":"#3b82f6"};\n             color: white;\n             padding: 1rem 1.5rem;\n             border-radius: 0.5rem;\n             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);\n             z-index: 1000;\n             font-weight: 600;\n             max-width: 300px;\n             word-wrap: break-word;\n           `,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},3e3)}function n(){const e=window.timelineData.stats,t=document.getElementById("total-incidents"),n=document.getElementById("critical-incidents"),a=document.getElementById("affected-countries");t&&(t.textContent=e.totalIncidents),n&&(n.textContent=e.criticalIncidents),a&&(a.textContent=e.affectedCountries)}function a(e=window.timelineData.events){const t=document.querySelector(".recent-attacks");t&&(t.innerHTML="",e.forEach(e=>{const n=document.createElement("div");n.className=`attack-item ${e.severity}`;const a=e.tags.map(e=>`<span class="attack-tag">#${e}</span>`).join("");var i;n.innerHTML=`\n               <div class="attack-header">\n                 <div class="attack-time">${function(e){const t=new Date,n=new Date(e),a=t.getTime()-n.getTime(),i=Math.floor(a/36e5),o=Math.floor(a/6e4);return i>0?`Hace ${i} hora${i>1?"s":""}`:o>0?`Hace ${o} minuto${o>1?"s":""}`:"Hace unos momentos"}(e.time)}</div>\n                 <div class="attack-severity ${e.severity}">${e.severity}</div>\n               </div>\n               <div class="attack-title">${e.title}</div>\n               <div class="attack-description">${e.description}</div>\n               <div class="attack-details">\n                 <div class="attack-detail">\n                   <span class="attack-detail-icon">🎯</span>\n                   <span class="attack-detail-value">${e.flag} ${e.country}</span>\n                 </div>\n                 <div class="attack-detail">\n                   <span class="attack-detail-icon">${i=e.threatType,{Ransomware:"🔒",Phishing:"🎣",Botnet:"🕸️",APT:"🎯",DDoS:"⚡",Malware:"🦠",Reconnaissance:"🔍",Cryptojacking:"⛏️"}[i]||"⚠️"}</span>\n                   <span class="attack-detail-value">${e.threatType}</span>\n                 </div>\n               </div>\n               <div class="attack-tags">\n                 ${a}\n               </div>\n             `,t.appendChild(n)}))}function i(e){const t=new Date;let n;switch(e){case"24h":n=new Date(t.getTime()-864e5);break;case"7d":n=new Date(t.getTime()-6048e5);break;case"30d":n=new Date(t.getTime()-2592e6);break;default:return window.timelineData.events}return window.timelineData.events.filter(e=>new Date(e.time)>=n)}function o(e,t){if("all"===e)return t;const n={"crítica":["crítica"],alta:["crítica","alta"],media:["crítica","alta","media"]}[e]||[e];return t.filter(e=>n.includes(e.severity))}e();let r={isOnline:navigator.onLine,retryCount:0,maxRetries:3,baseInterval:12e4,currentInterval:12e4,maxInterval:6e5,lastSuccessfulUpdate:Date.now()};function s(e,t,n){return{start(){this.stop();const a=async()=>{try{if(!r.isOnline)return void console.log(`Polling ${t} pausado - sin conexión`);console.log(`Ejecutando polling ${t}...`),await e(),r.retryCount=0,r.currentInterval=n,r.lastSuccessfulUpdate=Date.now()}catch(i){console.error(`Error en polling ${t}:`,i),r.retryCount++,r.retryCount<=r.maxRetries?(r.currentInterval=Math.min(n*Math.pow(2,r.retryCount),r.maxInterval),console.log(`Reintentando ${t} en ${r.currentInterval/1e3}s (intento ${r.retryCount}/${r.maxRetries})`)):(console.error(`Máximo de reintentos alcanzado para ${t}`),r.currentInterval=r.maxInterval)}this.timer=setTimeout(a,r.currentInterval)};a()},stop(){this.timer&&(clearTimeout(this.timer),this.timer=null)},timer:null}}const c=s(e,"timeline",12e4),d=s(()=>{if(window.loadCountryData&&"function"==typeof window.loadCountryData)return window.loadCountryData();console.warn("loadCountryData not available yet")},"country",45e3);window.addEventListener("online",()=>{console.log("Conexión restaurada - reanudando polling"),r.isOnline=!0,r.retryCount=0,r.currentInterval=r.baseInterval,c.start(),d.start()}),window.addEventListener("offline",()=>{console.log("Conexión perdida - pausando polling"),r.isOnline=!1,c.stop(),d.stop()}),document.addEventListener("visibilitychange",()=>{if(!document.hidden&&r.isOnline){Date.now()-r.lastSuccessfulUpdate>12e4&&(console.log("Página visible después de tiempo prolongado - actualizando datos"),e(),window.loadCountryData&&window.loadCountryData())}}),n(),a(),function(){const e=document.querySelector(".timeline-period-select"),r=document.querySelector(".timeline-severity-filter"),s=document.querySelector(".timeline-refresh-btn");e&&e.addEventListener("change",function(){const e=this.value,n=r?r.value:"all";let s=i(e);s=o(n,s),a(s),t(`Timeline actualizado para ${this.options[this.selectedIndex].text}`,"info")}),r&&r.addEventListener("change",function(){const n=this.value;let r=i(e?e.value:"24h");r=o(n,r),a(r),t(`Filtrado por severidad: ${this.options[this.selectedIndex].text}`,"info")}),s&&s.addEventListener("click",function(){this.disabled=!0,this.textContent="Actualizando...",setTimeout(()=>{const e={id:window.timelineData.events.length+1,time:(new Date).toISOString().slice(0,19).replace("T"," "),severity:"alta",title:"Nuevo Incidente Detectado",description:"Actividad sospechosa detectada en tiempo real por nuestros sistemas de monitoreo.",country:"Global",flag:"🌍",threatType:"Monitoring",affectedSystems:350,source:"Real-time Monitoring",tags:["tiempo-real","monitoreo","nuevo"]};window.timelineData.events.unshift(e),window.timelineData.stats.totalIncidents++,"crítica"===e.severity&&window.timelineData.stats.criticalIncidents++,n(),a(),this.disabled=!1,this.textContent="🔄 Actualizar Timeline",t("Timeline actualizado con nuevos incidentes","success")},2e3)})}(),c.start(),d.start()});
