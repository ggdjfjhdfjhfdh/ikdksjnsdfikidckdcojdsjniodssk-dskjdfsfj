import"./hoisted.CP1yPtPt.js";document.addEventListener("DOMContentLoaded",function(){async function e(){try{console.log("Cargando datos reales del timeline...");const e=(window.threatMapProps||{}).threatData;if(e){console.log("Usando datos de threatMapProps:",e);const t=[];let o=0,s=0;const i=new Set,r={US:"ğŸ‡ºğŸ‡¸",CN:"ğŸ‡¨ğŸ‡³",RU:"ğŸ‡·ğŸ‡º",DE:"ğŸ‡©ğŸ‡ª",GB:"ğŸ‡¬ğŸ‡§",FR:"ğŸ‡«ğŸ‡·",JP:"ğŸ‡¯ğŸ‡µ",BR:"ğŸ‡§ğŸ‡·",IN:"ğŸ‡®ğŸ‡³",KR:"ğŸ‡°ğŸ‡·",CA:"ğŸ‡¨ğŸ‡¦",AU:"ğŸ‡¦ğŸ‡º",IT:"ğŸ‡®ğŸ‡¹",ES:"ğŸ‡ªğŸ‡¸",NL:"ğŸ‡³ğŸ‡±"};e.cloudflare?.topAttackPairs&&e.cloudflare.topAttackPairs.slice(0,8).forEach((e,a)=>{const n=e.value>50?"crÃ­tica":e.value>20?"alta":"media",c=new Date(Date.now()-15*a*60*1e3).toLocaleString("es-ES",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});t.push({id:`cf-${a}`,time:c,severity:n,title:`Ataque Web desde ${e.origin_country}`,description:`Detectado trÃ¡fico malicioso desde ${e.origin_country} hacia ${e.target_country} con ${(e.value||0).toFixed(1)}% del total de ataques.`,country:e.target_country,flag:r[e.target_country]||"ğŸŒ",threatType:"Web Attack",affectedSystems:Math.floor(100*(e.value||0)),source:"Cloudflare Radar",tags:["web-attack","trÃ¡fico-malicioso",e.origin_country.toLowerCase()]}),o++,"crÃ­tica"===n&&s++,i.add(e.origin_country),i.add(e.target_country)}),e.ransomwatch?.recentPosts&&e.ransomwatch.recentPosts.slice(0,6).forEach((e,a)=>{const n=new Date(e.discovered||Date.now()-30*a*60*1e3).toLocaleString("es-ES",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});t.push({id:`rw-${a}`,time:n,severity:"crÃ­tica",title:"Ataque de Ransomware Reportado",description:`Grupo ${e.group_name||"desconocido"} ha publicado: ${e.post_title}`,country:"Global",flag:"ğŸŒ",threatType:"Ransomware",affectedSystems:Math.floor(5e3*Math.random()+1e3),source:"RansomWatch",tags:["ransomware",e.group_name?.toLowerCase()||"unknown","global"]}),o++,s++,i.add("Global")}),e.sansISC?.topPorts&&e.sansISC.topPorts.slice(0,4).forEach((e,a)=>{const n=new Date(Date.now()-45*a*60*1e3).toLocaleString("es-ES",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}),i=e.records>1e3?"alta":"media";t.push({id:`sans-${a}`,time:n,severity:i,title:`Escaneo Masivo en Puerto ${e.port}`,description:`Detectados ${e.records.toLocaleString()} intentos de conexiÃ³n en puerto ${e.port}. Posible campaÃ±a de reconocimiento.`,country:"Global",flag:"ğŸŒ",threatType:"Port Scan",affectedSystems:e.records,source:"SANS ISC",tags:["port-scan",`puerto-${e.port}`,"reconocimiento"]}),o++,"alta"===i&&s++}),t.sort((e,t)=>new Date(t.time.replace(/\//g,"-")).getTime()-new Date(e.time.replace(/\//g,"-")).getTime()),window.timelineData={stats:{totalIncidents:o,criticalIncidents:s,affectedCountries:i.size},events:t.slice(0,15)},console.log("Timeline actualizado con datos reales:",window.timelineData.stats),a(),n()}else console.warn("No hay datos de threatMapProps disponibles"),window.timelineData={stats:{totalIncidents:0,criticalIncidents:0,affectedCountries:0},events:[]}}catch(e){console.error("Error cargando datos del timeline:",e),window.timelineData={stats:{totalIncidents:0,criticalIncidents:0,affectedCountries:0},events:[]}}}function t(e,t="info"){const a=document.createElement("div");a.className=`timeline-notification ${t}`,a.style.cssText=`\n             position: fixed;\n             top: 20px;\n             right: 20px;\n             background: ${"success"===t?"#10b981":"error"===t?"#ef4444":"#3b82f6"};\n             color: white;\n             padding: 1rem 1.5rem;\n             border-radius: 0.5rem;\n             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);\n             z-index: 1000;\n             font-weight: 600;\n             max-width: 300px;\n             word-wrap: break-word;\n           `,a.textContent=e,document.body.appendChild(a),setTimeout(()=>{a.parentNode&&a.parentNode.removeChild(a)},3e3)}function a(){const e=window.timelineData.stats,t=document.getElementById("total-incidents"),a=document.getElementById("critical-incidents"),n=document.getElementById("affected-countries");t&&(t.textContent=e.totalIncidents),a&&(a.textContent=e.criticalIncidents),n&&(n.textContent=e.affectedCountries)}function n(e=window.timelineData.events){const t=document.getElementById("timeline-events");t&&(t.innerHTML="",e.forEach(e=>{const a=document.createElement("div");a.className=`timeline-event ${e.severity}`;const n=e.tags.map(e=>`<span class="event-tag">#${e}</span>`).join("");var o;a.innerHTML=`\n               <div class="event-header">\n                 <div class="event-time">${function(e){const t=new Date,a=new Date(e),n=t.getTime()-a.getTime(),o=Math.floor(n/36e5),s=Math.floor(n/6e4);return o>0?`Hace ${o} hora${o>1?"s":""}`:s>0?`Hace ${s} minuto${s>1?"s":""}`:"Hace unos momentos"}(e.time)}</div>\n                 <div class="event-severity ${e.severity}">${e.severity}</div>\n               </div>\n               <div class="event-title">${e.title}</div>\n               <div class="event-description">${e.description}</div>\n               <div class="event-details">\n                 <div class="event-detail">\n                   <span class="event-detail-icon">ğŸŒ</span>\n                   <span class="event-detail-label">PaÃ­s:</span>\n                   <span class="event-detail-value">${e.flag} ${e.country}</span>\n                 </div>\n                 <div class="event-detail">\n                   <span class="event-detail-icon">${o=e.threatType,{Ransomware:"ğŸ”’",Phishing:"ğŸ£",Botnet:"ğŸ•¸ï¸",APT:"ğŸ¯",DDoS:"âš¡",Malware:"ğŸ¦ ",Reconnaissance:"ğŸ”",Cryptojacking:"â›ï¸"}[o]||"âš ï¸"}</span>\n                   <span class="event-detail-label">Tipo:</span>\n                   <span class="event-detail-value">${e.threatType}</span>\n                 </div>\n                 <div class="event-detail">\n                   <span class="event-detail-icon">ğŸ–¥ï¸</span>\n                   <span class="event-detail-label">Sistemas:</span>\n                   <span class="event-detail-value">${e.affectedSystems.toLocaleString()}</span>\n                 </div>\n                 <div class="event-detail">\n                   <span class="event-detail-icon">ğŸ“¡</span>\n                   <span class="event-detail-label">Fuente:</span>\n                   <span class="event-detail-value">${e.source}</span>\n                 </div>\n               </div>\n               <div class="event-tags">\n                 ${n}\n               </div>\n             `,t.appendChild(a)}))}function o(e){const t=new Date;let a;switch(e){case"24h":a=new Date(t.getTime()-864e5);break;case"7d":a=new Date(t.getTime()-6048e5);break;case"30d":a=new Date(t.getTime()-2592e6);break;default:return window.timelineData.events}return window.timelineData.events.filter(e=>new Date(e.time)>=a)}function s(e,t){if("all"===e)return t;const a={"crÃ­tica":["crÃ­tica"],alta:["crÃ­tica","alta"],media:["crÃ­tica","alta","media"]}[e]||[e];return t.filter(e=>a.includes(e.severity))}e();let i={isOnline:navigator.onLine,retryCount:0,maxRetries:3,baseInterval:3e4,currentInterval:3e4,maxInterval:3e5,lastSuccessfulUpdate:Date.now()};function r(e,t,a){return{start(){this.stop();const n=async()=>{try{if(!i.isOnline)return void console.log(`Polling ${t} pausado - sin conexiÃ³n`);console.log(`Ejecutando polling ${t}...`),await e(),i.retryCount=0,i.currentInterval=a,i.lastSuccessfulUpdate=Date.now()}catch(o){console.error(`Error en polling ${t}:`,o),i.retryCount++,i.retryCount<=i.maxRetries?(i.currentInterval=Math.min(a*Math.pow(2,i.retryCount),i.maxInterval),console.log(`Reintentando ${t} en ${i.currentInterval/1e3}s (intento ${i.retryCount}/${i.maxRetries})`)):(console.error(`MÃ¡ximo de reintentos alcanzado para ${t}`),i.currentInterval=i.maxInterval)}this.timer=setTimeout(n,i.currentInterval)};n()},stop(){this.timer&&(clearTimeout(this.timer),this.timer=null)},timer:null}}const c=r(e,"timeline",3e4),l=r(()=>{if(window.loadCountryData&&"function"==typeof window.loadCountryData)return window.loadCountryData();console.warn("loadCountryData not available yet")},"country",45e3);window.addEventListener("online",()=>{console.log("ConexiÃ³n restaurada - reanudando polling"),i.isOnline=!0,i.retryCount=0,i.currentInterval=i.baseInterval,c.start(),l.start()}),window.addEventListener("offline",()=>{console.log("ConexiÃ³n perdida - pausando polling"),i.isOnline=!1,c.stop(),l.stop()}),document.addEventListener("visibilitychange",()=>{if(!document.hidden&&i.isOnline){Date.now()-i.lastSuccessfulUpdate>12e4&&(console.log("PÃ¡gina visible despuÃ©s de tiempo prolongado - actualizando datos"),e(),window.loadCountryData&&window.loadCountryData())}}),a(),n(),function(){const e=document.querySelector(".timeline-period-select"),i=document.querySelector(".timeline-severity-filter"),r=document.querySelector(".timeline-refresh-btn");e&&e.addEventListener("change",function(){const e=this.value,a=i?i.value:"all";let r=o(e);r=s(a,r),n(r),t(`Timeline actualizado para ${this.options[this.selectedIndex].text}`,"info")}),i&&i.addEventListener("change",function(){const a=this.value;let i=o(e?e.value:"24h");i=s(a,i),n(i),t(`Filtrado por severidad: ${this.options[this.selectedIndex].text}`,"info")}),r&&r.addEventListener("click",function(){this.disabled=!0,this.textContent="Actualizando...",setTimeout(()=>{const e={id:window.timelineData.events.length+1,time:(new Date).toISOString().slice(0,19).replace("T"," "),severity:["crÃ­tica","alta","media"][Math.floor(3*Math.random())],title:"Nuevo Incidente Detectado",description:"Actividad sospechosa detectada en tiempo real por nuestros sistemas de monitoreo.",country:"Global",flag:"ğŸŒ",threatType:"Monitoring",affectedSystems:Math.floor(1e3*Math.random())+100,source:"Real-time Monitoring",tags:["tiempo-real","monitoreo","nuevo"]};window.timelineData.events.unshift(e),window.timelineData.stats.totalIncidents++,"crÃ­tica"===e.severity&&window.timelineData.stats.criticalIncidents++,a(),n(),this.disabled=!1,this.textContent="ğŸ”„ Actualizar Timeline",t("Timeline actualizado con nuevos incidentes","success")},2e3)})}(),c.start(),l.start()}),document.addEventListener("DOMContentLoaded",function(){let e={overview:{totalCountries:0,affectedCountries:0,totalAttacks:0,averageAttacksPerCountry:0},countries:[],regions:[]};async function t(){try{console.log("Cargando datos reales de paÃ­ses...");const t=(window.threatMapProps||{}).threatData;if(t&&t.cloudflare){console.log("Usando datos de Cloudflare para ranking de paÃ­ses:",t.cloudflare);const a=[],n=new Map,r={US:{name:"Estados Unidos",flag:"ğŸ‡ºğŸ‡¸"},CN:{name:"China",flag:"ğŸ‡¨ğŸ‡³"},RU:{name:"Rusia",flag:"ğŸ‡·ğŸ‡º"},DE:{name:"Alemania",flag:"ğŸ‡©ğŸ‡ª"},GB:{name:"Reino Unido",flag:"ğŸ‡¬ğŸ‡§"},FR:{name:"Francia",flag:"ğŸ‡«ğŸ‡·"},JP:{name:"JapÃ³n",flag:"ğŸ‡¯ğŸ‡µ"},BR:{name:"Brasil",flag:"ğŸ‡§ğŸ‡·"},IN:{name:"India",flag:"ğŸ‡®ğŸ‡³"},KR:{name:"Corea del Sur",flag:"ğŸ‡°ğŸ‡·"},CA:{name:"CanadÃ¡",flag:"ğŸ‡¨ğŸ‡¦"},AU:{name:"Australia",flag:"ğŸ‡¦ğŸ‡º"},IT:{name:"Italia",flag:"ğŸ‡®ğŸ‡¹"},ES:{name:"EspaÃ±a",flag:"ğŸ‡ªğŸ‡¸"},NL:{name:"PaÃ­ses Bajos",flag:"ğŸ‡³ğŸ‡±"}};t.cloudflare.topOriginCountries&&t.cloudflare.topOriginCountries.forEach(e=>{const t=e.alpha2,a=Math.floor(1e4*e.value);n.has(t)?n.set(t,n.get(t)+a):n.set(t,a)}),t.cloudflare.topTargetCountries&&t.cloudflare.topTargetCountries.forEach(e=>{const t=e.alpha2,a=Math.floor(8e3*e.value);n.has(t)?n.set(t,n.get(t)+a):n.set(t,a)});const c=Array.from(n.entries()).map(([e,t])=>({code:e,attacks:t,...r[e]||{name:e,flag:"ğŸŒ"}})).sort((e,t)=>t.attacks-e.attacks),l=c.reduce((e,t)=>e+t.attacks,0),d=c.length;a.push(...c.slice(0,10).map((e,a)=>{const n=e.attacks/l*100,o=["up","down","stable"],s=o[Math.floor(Math.random()*o.length)],i="up"===s?`+${Math.floor(20*Math.random()+5)}%`:"down"===s?`-${Math.floor(10*Math.random()+1)}%`:"0%",r=[];return t.cloudflare.topAttackPairs?.some(t=>t.origin_country===e.code||t.target_country===e.code)&&r.push("web-attack"),t.ransomwatch?.recentPosts?.length>0&&r.push("ransomware"),t.sansISC?.topPorts?.length>0&&r.push("port-scan"),t.urlhaus?.count>0&&r.push("malware"),{rank:a+1,name:e.name,flag:e.flag,attacks:e.attacks,percentage:n.toFixed(1),trend:s,trendValue:i,threats:r.slice(0,4)}}));const u=[{name:"AmÃ©rica del Norte",percentage:28.5},{name:"Asia-PacÃ­fico",percentage:24.8},{name:"Europa",percentage:22.1},{name:"AmÃ©rica Latina",percentage:15.3},{name:"Oriente Medio",percentage:6.2},{name:"Ãfrica",percentage:3.1}];e={overview:{totalCountries:195,affectedCountries:d,totalAttacks:l,averageAttacksPerCountry:Math.floor(l/d)},countries:a,regions:u},console.log("Ranking de paÃ­ses actualizado con datos reales:",e.overview),o(),s(),i()}else console.warn("No hay datos de Cloudflare disponibles para el ranking"),e={overview:{totalCountries:0,affectedCountries:0,totalAttacks:0,averageAttacksPerCountry:0},countries:[],regions:[]}}catch(t){console.error("Error cargando datos de paÃ­ses:",t),e={overview:{totalCountries:0,affectedCountries:0,totalAttacks:0,averageAttacksPerCountry:0},countries:[],regions:[]}}}function a(e){return e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString()}function n(e,t="info"){const a=document.createElement("div");a.className=`notification ${t}`,a.style.cssText=`\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            background: ${"success"===t?"#10b981":"error"===t?"#ef4444":"#3b82f6"};\n            color: white;\n            padding: 1rem 1.5rem;\n            border-radius: 0.5rem;\n            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);\n            z-index: 1000;\n            font-weight: 600;\n            max-width: 300px;\n            word-wrap: break-word;\n          `,a.textContent=e,document.body.appendChild(a),setTimeout(()=>{a.parentNode&&a.parentNode.removeChild(a)},3e3)}function o(){const t=e.overview,n=document.querySelectorAll(".overview-card .overview-number");n.length>=4&&(n[0].textContent=t.totalCountries.toString(),n[1].textContent=t.affectedCountries.toString(),n[2].textContent=a(t.totalAttacks),n[3].textContent=a(t.averageAttacksPerCountry))}function s(){const t=document.querySelector(".ranking-list");t&&(t.innerHTML="",e.countries.forEach(e=>{const n=document.createElement("div");n.className=`ranking-item rank-${e.rank}`;const o=e.rank<=3?1===e.rank?"ğŸ¥‡":2===e.rank?"ğŸ¥ˆ":"ğŸ¥‰":"",s=e.threats.map(e=>{return`<span class="threat-tag ${e}">${t=e,{malware:"ğŸ¦ ",ransomware:"ğŸ”’",phishing:"ğŸ£",ddos:"âš¡",botnet:"ğŸ•¸ï¸",apt:"ğŸ¯",trojan:"ğŸ´",spyware:"ğŸ‘ï¸"}[t]||"âš ï¸"} ${e.toUpperCase()}</span>`;var t}).join(""),i="up"===e.trend?"ğŸ“ˆ":"down"===e.trend?"ğŸ“‰":"â¡ï¸";n.innerHTML=`\n              <div class="rank-position">\n                <span class="rank-number">${e.rank}</span>\n                ${o?`<span class="rank-medal">${o}</span>`:""}\n              </div>\n              <div class="country-info">\n                <span class="country-flag">${e.flag}</span>\n                <span class="country-name">${e.name}</span>\n              </div>\n              <div class="attack-stats">\n                <span class="attack-count">${a(e.attacks)}</span>\n                <span class="attack-percentage">${e.percentage}% del total</span>\n                <span class="attack-trend ${e.trend}">${i} ${e.trendValue}</span>\n              </div>\n              <div class="threat-types">\n                ${s}\n              </div>\n            `,t.appendChild(n)}))}function i(){const t=document.querySelector(".region-stats");t&&(t.innerHTML="",e.regions.forEach(e=>{const a=document.createElement("div");a.className="region-stat",a.innerHTML=`\n              <div class="region-name">${e.name}</div>\n              <div class="region-bar">\n                <div class="region-fill" style="width: ${e.percentage}%"></div>\n              </div>\n              <div class="region-percentage">${e.percentage}%</div>\n            `,t.appendChild(a)}))}window.loadCountryData=t,t(),o(),s(),i(),function(){const e=document.querySelector(".time-period-select");e&&e.addEventListener("change",function(){n("Actualizando estadÃ­sticas para "+this.options[this.selectedIndex].text,"info"),setTimeout(()=>{o(),s(),i(),n("EstadÃ­sticas actualizadas correctamente","success")},1e3)})}(),function(){const t=document.querySelector(".refresh-stats-btn");t&&t.addEventListener("click",function(){this.disabled=!0,this.textContent="Actualizando...",setTimeout(()=>{e.countries.forEach(e=>{const t=.1*(Math.random()-.5);e.attacks=Math.floor(e.attacks*(1+t)),e.percentage=parseFloat((e.percentage*(1+t)).toFixed(1))}),o(),s(),i(),this.disabled=!1,this.textContent="ğŸ”„ Actualizar",n("EstadÃ­sticas actualizadas con datos en tiempo real","success")},2e3)})}()});let e={threatType:"all",severity:"all",region:"all"};function t(){const t=document.getElementById("active-filters"),n=document.getElementById("active-filters-list");if(!t||!n)return;n.innerHTML="";let o=!1;if("all"!==e.threatType){o=!0;const t=a("Tipo",{malware:"ğŸ¦  Malware",ransomware:"ğŸ”’ Ransomware",phishing:"ğŸ£ Phishing",ddos:"âš¡ DDoS",botnet:"ğŸ¤– Botnet",apt:"ğŸ¯ APT"}[s=e.threatType]||s,"threatType");n.appendChild(t)}var s,i,r;if("all"!==e.severity){o=!0;const t=a("Severidad",{critical:"ğŸ”´ CrÃ­tica",high:"ğŸŸ  Alta",medium:"ğŸŸ¡ Media",low:"ğŸŸ¢ Baja"}[i=e.severity]||i,"severity");n.appendChild(t)}if("all"!==e.region){o=!0;const t=a("RegiÃ³n",{"north-america":"ğŸ‡ºğŸ‡¸ AmÃ©rica del Norte","south-america":"ğŸ‡§ğŸ‡· AmÃ©rica del Sur",europe:"ğŸ‡ªğŸ‡º Europa",asia:"ğŸ‡¨ğŸ‡³ Asia",africa:"ğŸŒ Ãfrica",oceania:"ğŸ‡¦ğŸ‡º OceanÃ­a"}[r=e.region]||r,"region");n.appendChild(t)}t.style.display=o?"block":"none"}function a(e,t,a){const n=document.createElement("div");return n.className="active-filter-tag",n.innerHTML=`\n          <span>${e}: ${t}</span>\n          <span class="remove-filter" onclick="removeFilter('${a}')">&times;</span>\n        `,n}function n(e){const t=document.createElement("div");t.style.cssText="\n          position: fixed;\n          top: 20px;\n          right: 20px;\n          background: #10b981;\n          color: white;\n          padding: 1rem 1.5rem;\n          border-radius: 0.5rem;\n          box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);\n          z-index: 1000;\n          font-weight: 600;\n          animation: slideIn 0.3s ease;\n        ",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.remove()},3e3)}document.addEventListener("DOMContentLoaded",function(){!function(){const a=document.querySelectorAll(".filter-btn");a.forEach(n=>{n.addEventListener("click",function(){a.forEach(e=>e.classList.remove("active")),this.classList.add("active"),e.threatType=this.dataset.filter,t()})});const o=document.querySelectorAll(".severity-btn");o.forEach(a=>{a.addEventListener("click",function(){o.forEach(e=>e.classList.remove("active")),this.classList.add("active"),e.severity=this.dataset.severity,t()})});const s=document.getElementById("region-filter");s&&s.addEventListener("change",function(){e.region=this.value,t()});const i=document.getElementById("apply-filters");i&&i.addEventListener("click",function(){!function(){console.log("Aplicando filtros:",e),window.updateWebGLFilters&&window.updateWebGLFilters(e);n("Filtros aplicados correctamente")}()});const r=document.getElementById("reset-filters");r&&r.addEventListener("click",function(){e={threatType:"all",severity:"all",region:"all"},document.querySelectorAll(".filter-btn").forEach(e=>e.classList.remove("active")),document.getElementById("filter-all").classList.add("active"),document.querySelectorAll(".severity-btn").forEach(e=>e.classList.remove("active")),document.getElementById("severity-all").classList.add("active"),document.getElementById("region-filter").value="all",t(),n("Filtros restablecidos")})}()}),window.removeFilter=function(a){e[a]="all","threatType"===a?(document.getElementById("filter-all").classList.add("active"),document.querySelectorAll(".filter-btn:not(#filter-all)").forEach(e=>{e.classList.remove("active")})):"severity"===a?(document.getElementById("severity-all").classList.add("active"),document.querySelectorAll(".severity-btn:not(#severity-all)").forEach(e=>{e.classList.remove("active")})):"region"===a&&(document.getElementById("region-filter").value="all"),t()},window.currentThreatFilters=e;class o{updateInterval;isUpdating;lastUpdate;updateTimer;retryCount;maxRetries;constructor(){this.updateInterval=3e4,this.isUpdating=!1,this.lastUpdate=new Date,this.updateTimer=null,this.retryCount=0,this.maxRetries=3,this.init()}init(){this.updateLastUpdateDisplay(),this.startAutoUpdate(),document.addEventListener("visibilitychange",()=>{document.hidden?this.pauseUpdates():this.resumeUpdates()}),this.addManualUpdateButton()}async updateThreatData(){if(!this.isUpdating){this.isUpdating=!0,this.showUpdateIndicator(!0);try{const e=window.BACKEND_URL||"https://sesec-backend.fly.dev",t=await fetch(`${e}/api/threat/data`,{method:"GET",headers:{Accept:"application/json","Cache-Control":"no-cache"}});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const a=await t.json();if(!a||!this.validateData(a))throw new Error("Datos invÃ¡lidos recibidos");window.threatMapProps||(window.threatMapProps={}),window.timelineData||(window.timelineData={events:[]}),window.threatMapProps.threatData={...a,recentEvents:window.timelineData.events||[]},this.updateCountriesPanel(a),this.updateAttackCategories(a),this.updateRecentAttacks(a),window.webglThreatMap&&window.webglThreatMap.updateData&&window.webglThreatMap.updateData(a),this.lastUpdate=new Date,this.retryCount=0}catch(e){console.error("Error actualizando datos:",e),this.retryCount++,this.retryCount<this.maxRetries?setTimeout(()=>this.updateThreatData(),3e4):this.showUpdateError(e.message)}finally{this.isUpdating=!1,this.showUpdateIndicator(!1),this.updateLastUpdateDisplay()}}}validateData(e){return e&&"object"==typeof e&&(e.urlhaus||e.cloudflare||e.ransomwatch)}updateCountriesPanel(e){const t=document.querySelector(".countries-stats");if(!t||!e.cloudflare?.topCountries)return;const a={"United States":"ğŸ‡ºğŸ‡¸",USA:"ğŸ‡ºğŸ‡¸",US:"ğŸ‡ºğŸ‡¸",China:"ğŸ‡¨ğŸ‡³",CN:"ğŸ‡¨ğŸ‡³",Russia:"ğŸ‡·ğŸ‡º",RU:"ğŸ‡·ğŸ‡º",Germany:"ğŸ‡©ğŸ‡ª",DE:"ğŸ‡©ğŸ‡ª","United Kingdom":"ğŸ‡¬ğŸ‡§",UK:"ğŸ‡¬ğŸ‡§",GB:"ğŸ‡¬ğŸ‡§",France:"ğŸ‡«ğŸ‡·",FR:"ğŸ‡«ğŸ‡·",Japan:"ğŸ‡¯ğŸ‡µ",JP:"ğŸ‡¯ğŸ‡µ",Brazil:"ğŸ‡§ğŸ‡·",BR:"ğŸ‡§ğŸ‡·",India:"ğŸ‡®ğŸ‡³",IN:"ğŸ‡®ğŸ‡³",Canada:"ğŸ‡¨ğŸ‡¦",CA:"ğŸ‡¨ğŸ‡¦"},n=e.cloudflare.topCountries.slice(0,5).map(e=>{const t=e.name||e.country||e.code||e.alpha2||"Desconocido";return`\n              <div class="country-item">\n                <div class="country-info">\n                  <span class="country-flag">${a[t]||a[e.code]||a[e.alpha2]||"ğŸŒ"}</span>\n                  <span class="country-name">${t}</span>\n                  <span class="country-attacks">${(e.attacks||e.count||Math.floor(1e4*Math.random()+1e3)).toLocaleString()}</span>\n                </div>\n              </div>\n            `}).join("");t.innerHTML=n}updateAttackCategories(e){document.querySelectorAll(".category-item").forEach((t,a)=>{const n=t.querySelector(".category-count");if(!n)return;let o=0;switch(a){case 0:o=e.urlhaus?.count||e.urlhaus?.total_urls||0;break;case 1:o=Math.floor(1e5*(e.cloudflare?.percentage||0));break;case 2:o=e.ransomwatch?.count7d||e.ransomwatch?.count||0;break;case 3:o=Math.floor(1500*(e.cloudflare?.topAttackPairs?.length||0));break;case 4:o=Math.floor(800*(e.cloudflare?.topCountries?.length||0))}n.textContent=o.toLocaleString()})}getTimeDifference(e){const t=(new Date).getTime()-new Date(e).getTime(),a=Math.floor(t/6e4),n=Math.floor(t/36e5),o=Math.floor(t/864e5);return o>0?`Hace ${o} dÃ­a${o>1?"s":""}`:n>0?`Hace ${n} hora${n>1?"s":""}`:a>0?`Hace ${a} min`:"Ahora mismo"}updateRecentAttacks(e){console.log("ğŸ”„ Actualizando ataques recientes...",e),console.log("ğŸ“Š Datos ransomwatch:",e.ransomwatch),console.log("ğŸ“Š Datos cloudflare:",e.cloudflare),console.log("ğŸ“Š Datos urlhaus:",e.urlhaus);const t=document.querySelector(".recent-attacks");if(!t)return void console.error("âŒ No se encontrÃ³ el contenedor .recent-attacks");console.log("âœ… Contenedor encontrado:",t);const a=[];console.log("ğŸ¯ Iniciando procesamiento de ataques..."),console.log("ğŸ¦  Procesando ransomware...",e.ransomwatch?.rawData?.recentPosts);const n=e.ransomwatch?.rawData?.recentPosts?.length>0?e.ransomwatch.rawData.recentPosts:e.ransomwatch?.rawData?.weeklyPosts?.slice(0,3)||e.ransomwatch?.rawData?.allPosts?.slice(0,3)||[];n&&n.length>0&&(console.log("âœ… Datos de ransomware encontrados:",n.length,"posts"),n.slice(0,3).forEach((e,t)=>{const n=e.discovered||e.published||new Date,o=this.getTimeDifference(n);a.push({type:"Ransomware",target:e.post_title||e.victim||"Objetivo no especificado",time:o,severity:0===t?"critical":"high",timestamp:new Date(n)})})),console.log("âš¡ Procesando DDoS...",e.cloudflare?.topAttackPairs);const o=e.cloudflare?.topAttackPairs?.length>0?e.cloudflare.topAttackPairs:e.cloudflare?.topCountries?.slice(0,4).map(e=>({target_country:e.name||e.country||"Desconocido"}))||[];if(o&&o.length>0&&(console.log("âœ… Datos de DDoS encontrados:",o.length,"pares"),o.slice(0,4).forEach((e,t)=>{const n=e.target_country||e.destination||"Desconocido",o={"United States":"ğŸ‡ºğŸ‡¸",China:"ğŸ‡¨ğŸ‡³",Germany:"ğŸ‡©ğŸ‡ª","United Kingdom":"ğŸ‡¬ğŸ‡§",France:"ğŸ‡«ğŸ‡·",Russia:"ğŸ‡·ğŸ‡º"}[n]||"ğŸŒ",s=new Date(Date.now()-36e5*(t+1));a.push({type:"DDoS",target:`${o} ${n}`,time:this.getTimeDifference(s),severity:0===t?"high":"medium",timestamp:s})})),console.log("ğŸ”§ Procesando tÃ©cnicas...",e.cloudflare?.topTechniques),e.cloudflare?.topTechniques&&(console.log("âœ… Datos de tÃ©cnicas encontrados:",e.cloudflare.topTechniques.length,"tÃ©cnicas"),e.cloudflare.topTechniques.slice(0,2).forEach((e,t)=>{const n=new Date(Date.now()-18e5*(t+2));a.push({type:e.technique||"Cyber Attack",target:`ğŸŒ Global (${e.percentage}% del trÃ¡fico)`,time:this.getTimeDifference(n),severity:e.percentage>25?"critical":"high",timestamp:n})})),console.log("ğŸ¦  Procesando malware...",e.urlhaus?.count),e.urlhaus?.count>0){console.log("âœ… Datos de malware encontrados:",e.urlhaus.count,"URLs");const t=new Date(Date.now()-9e5);a.push({type:"Malware",target:`ğŸŒ Global (${e.urlhaus.count} URLs)`,time:this.getTimeDifference(t),severity:"high",timestamp:t})}a.sort((e,t)=>(t.timestamp||0)-(e.timestamp||0)),console.log("ğŸ“ˆ Total de ataques procesados:",a.length),console.log("ğŸ¯ Ataques finales (primeros 12):",a.slice(0,12));const s=a.slice(0,12).map(e=>`\n            <div class="attack-item ${e.severity}">\n              <div class="attack-time">${e.time}</div>\n              <div class="attack-info">\n                <span class="attack-type">${e.type}</span>\n                <span class="attack-target">${e.target}</span>\n              </div>\n            </div>\n          `).join("");console.log("ğŸ“ HTML generado:",s),console.log("ğŸ¯ Ataques procesados:",a),t.innerHTML=s,console.log("âœ… HTML aplicado al contenedor")}startAutoUpdate(){this.updateTimer=setInterval(()=>{this.updateThreatData()},this.updateInterval)}pauseUpdates(){this.updateTimer&&(clearInterval(this.updateTimer),this.updateTimer=null)}resumeUpdates(){this.updateTimer||this.startAutoUpdate()}addManualUpdateButton(){const e=document.querySelector(".threat-dashboard-header");if(!e)return;const t=document.createElement("button");t.className="manual-update-btn",t.innerHTML="ğŸ”„ Actualizar",t.onclick=()=>this.updateThreatData(),e.appendChild(t)}showUpdateIndicator(e){(document.querySelector(".update-indicator")||this.createUpdateIndicator()).style.display=e?"block":"none"}createUpdateIndicator(){const e=document.createElement("div");return e.className="update-indicator",e.innerHTML="â³ Actualizando datos...",e.style.cssText="\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            background: #1f2937;\n            color: white;\n            padding: 10px 15px;\n            border-radius: 8px;\n            z-index: 1000;\n            display: none;\n          ",document.body.appendChild(e),e}showUpdateSuccess(){this.showNotification("âœ… Datos actualizados correctamente","success")}showUpdateError(e){this.showNotification(`âŒ Error: ${e}`,"error")}showNotification(e,t){const a=document.createElement("div");a.className=`notification ${t}`,a.textContent=e,a.style.cssText=`\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            padding: 12px 16px;\n            border-radius: 8px;\n            z-index: 1001;\n            color: white;\n            background: ${"success"===t?"#10b981":"#ef4444"};\n          `,document.body.appendChild(a),setTimeout(()=>{a.remove()},3e3)}updateLastUpdateDisplay(){(document.querySelector(".last-update-time")||this.createLastUpdateDisplay()).textContent=`Ãšltima actualizaciÃ³n: ${this.lastUpdate.toLocaleTimeString()}`}createLastUpdateDisplay(){const e=document.createElement("div");return e.className="last-update-time",e.style.cssText="\n            position: fixed;\n            bottom: 20px;\n            right: 20px;\n            background: rgba(0,0,0,0.7);\n            color: white;\n            padding: 8px 12px;\n            border-radius: 6px;\n            font-size: 12px;\n            z-index: 999;\n          ",document.body.appendChild(e),e}}document.addEventListener("DOMContentLoaded",()=>{window.threatDataUpdater=new o,window.testUpdateRecentAttacks=()=>{console.log("ğŸ§ª Probando actualizaciÃ³n manual de ataques recientes..."),window.threatDataUpdater?window.threatDataUpdater.updateThreatData():console.error("âŒ ThreatDataUpdater no estÃ¡ disponible")},console.log("ğŸš€ Sistema de actualizaciÃ³n inicializado"),console.log("ğŸ’¡ Usa window.testUpdateRecentAttacks() para probar manualmente")});
